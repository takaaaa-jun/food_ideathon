<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>基準レシピ検索結果: {{ query }}</title>
    <style>
        /* CSS from results.html */
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 2em auto;
            padding: 0 1em;
            background-color: #f9f9f9;
        }

        .result-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5em;
            margin-bottom: 1.5em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        h1,
        h2 {
            color: #333;
        }

        h2 {
            color: #d63384;
        }

        h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 0.3em;
            color: #555;
        }

        ul,
        ol {
            padding-left: 20px;
            margin-top: 0.5em;
        }

        li {
            margin-bottom: 0.7em;
            line-height: 1.6;
        }

        a {
            text-decoration: none;
            color: #007BFF;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Hybrid Search Styles */
        .search-form {
            margin-top: 2em;
            margin-bottom: 2em;
            text-align: center;
        }

        /* Tags Styles */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 30px;
            padding: 5px;
            width: 70%;
            margin: 0 auto 15px auto;
            justify-content: center;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #007BFF;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            gap: 5px;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            line-height: 1;
            padding: 0 4px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transition: background-color 0.2s;
        }

        .tag-remove:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        /* Row Styles */
        .condition-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .condition-select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
        }

        .search-input {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-size: 1em;
            width: 50%;
            box-sizing: border-box;
        }

        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
        }

        .remove-btn:hover {
            background-color: #c82333;
        }

        .add-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .add-btn:hover {
            background-color: #218838;
        }

        .submit-button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            background-color: #007BFF;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .submit-button:hover {
            background-color: #0056b3;
        }

        /* Specific styles for Standard Recipes (adapted) */
        .recipe-meta {
            margin-top: 0.5em;
            margin-bottom: 1em;
            color: #555;
            font-size: 0.9em;
            background-color: #f8f9fa;
            padding: 1em;
            border-radius: 5px;
        }

        .recipe-details-grid {
            display: flex;
            gap: 2em;
            align-items: flex-start;
            margin-top: 1em;
        }

        .ingredients-col,
        .steps-col {
            flex: 1;
            min-width: 0;
        }

        .toggle-button,
        .other-toggle-button {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding: 5px;
            transition: background-color 0.2s;
        }

        .toggle-button:hover,
        .other-toggle-button:hover {
            background-color: #f0f0f0;
        }

        .toggle-button .arrow,
        .other-toggle-button .arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease-in-out;
        }

        .toggle-button.open .arrow {
            transform: translateY(-50%) rotate(180deg);
        }

        .show-more-steps {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 0.5em 1em;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 1em;
            transition: background-color 0.2s;
        }

        .show-more-steps:hover {
            background-color: #0056b3;
        }

        @media (max-width: 700px) {
            .recipe-details-grid {
                flex-direction: column;
            }
        }

        /* Search Mode Radio Styles */
        .search-mode-options {
            text-align: center;
            margin-bottom: 10px;
        }

        .search-mode-options label {
            margin: 0 10px;
            cursor: pointer;
        }

        .initially-hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>
        基準レシピ検索結果: "{{ query }}"
        {% if search_mode == 'ingredient' %}
        <span style="font-size: 0.6em; color: #666;">(材料名検索)</span>
        {% else %}
        <span style="font-size: 0.6em; color: #666;">(レシピ名検索)</span>
        {% endif %}
    </h1>
    <p style="text-align: center;">
        <a href="/">← トップページに戻る</a> |
        <a href="{{ url_for('standard_search_home') }}">基準レシピの検索に戻る</a>
    </p>

    <!-- Search Form (Hybrid) -->
    <div class="search-form">
        <form id="searchForm" action="{{ url_for('standard_search') }}" method="post">

            <!-- Search Mode Selection (Preserved) -->
            <div class="search-mode-options">
                <label>
                    <input type="radio" name="search_mode" value="recipe" {% if search_mode !='ingredient' %}checked{%
                        endif %}> レシピ名
                </label>
                <label>
                    <input type="radio" name="search_mode" value="ingredient" {% if search_mode=='ingredient'
                        %}checked{% endif %}> 材料名
                </label>
            </div>

            <!-- 既存の検索条件（タグ） -->
            <div class="tags-container" id="tagsContainer">
                <!-- JavaScriptでここにタグを表示します -->
            </div>

            <!-- 新規追加用の行 -->
            <div id="conditionsContainer">
                <!-- JavaScriptでここに行を追加します -->
            </div>

            <button type="button" id="addConditionBtn" class="add-btn">＋ 条件を追加</button>
            <br>

            <input type="hidden" name="query" id="finalQuery">
            <!-- 初期クエリ保持用 -->
            <input type="hidden" id="initialQuery" value="{{ query }}">

            <input type="submit" value="再検索" class="submit-button">
        </form>
    </div>

    {% if error %}
    <p style="color: red; text-align: center;">{{ error }}</p>
    {% endif %}

    {% if basic_recipes %}
    <p style="text-align: center;">{{ total_count }}件中、上位{{ basic_recipes|length }}件を表示しています。</p>

    {% for recipe_name, details in basic_recipes %}
    <div class="result-item">
        <h2>{{ recipe_name }}</h2>

        <div class="recipe-meta">
            <p><strong>レシピ数:</strong> {{ details.recipe_count }}</p>
            <p><strong>調理時間:</strong>
                {% if details.cooking_time and details.cooking_time|length > 0 %}
                {{ cooking_time_map.get(details.cooking_time[0], '情報なし') }}
                {% else %}
                情報なし
                {% endif %}
            </p>
            <p><strong>平均手順数:</strong> {{ details.steps.average_steps }}</p>
        </div>

        <div class="recipe-details-grid">
            <div class="ingredients-col">
                <h3>材料の内訳</h3>
                {% set recipe_threshold = details.recipe_count * 0.2 %}

                {# --- Ingredient Logic (Copied from original) --- #}
                {% for category_name, ingredients in details.ingredient.items() %}
                {% if ingredients.all[0] >= recipe_threshold %}
                <div class="ingredient-category">
                    {% set has_less_common = namespace(found=false) %}
                    {% for ingredient_name, count_list in ingredients.items() %}
                    {% if ingredient_name != 'all' and count_list[0] < ingredients.all[0] * 0.2 %} {% set
                        has_less_common.found=true %} {% endif %} {% endfor %} <h4 class="toggle-button">
                        {{ category_name }} (合計: {{ ingredients.all[0] }}件)
                        {% if has_less_common.found %}
                        <span class="arrow">▼</span>
                        {% endif %}
                        </h4>
                        <ul>
                            {% set threshold = ingredients.all[0] * 0.2 %}
                            {% set visible_count = namespace(value=0) %}
                            {% for ingredient_name, count_list in ingredients|dictsort(by='value', reverse=True) %}
                            {% if ingredient_name != 'all' and count_list[0] >= threshold %}
                            {% set visible_count.value = visible_count.value + 1 %}
                            {% endif %}
                            {% endfor %}

                            {% set first_item_shown = namespace(value=false) %}
                            {% for ingredient_name, count_list in ingredients|dictsort(by='value', reverse=True) %}
                            {% if ingredient_name != 'all' %}
                            {% if count_list[0] >= threshold %}
                            <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                            {% set first_item_shown.value = true %}
                            {% elif visible_count.value == 0 and not first_item_shown.value %}
                            <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                            {% set first_item_shown.value = true %}
                            {% else %}
                            <li class="less-common" style="display: none;">{{ ingredient_name }}: {{ count_list[0] }}件
                            </li>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </ul>
                </div>
                {% endif %}
                {% endfor %}

                <div class="other-categories-block">
                    <h3 class="other-toggle-button">その他の分類 <span class="arrow">▼</span></h3>
                    <div class="other-toggle-content" style="display: none;">
                        {% for category_name, ingredients in details.ingredient.items() %}
                        {% if ingredients.all[0] < recipe_threshold %} <div class="ingredient-category">
                            {% set has_less_common = namespace(found=false) %}
                            {% for ingredient_name, count_list in ingredients.items() %}
                            {% if ingredient_name != 'all' and count_list[0] < ingredients.all[0] * 0.2 %} {% set
                                has_less_common.found=true %} {% endif %} {% endfor %} <h4 class="toggle-button">
                                {{ category_name }} (合計: {{ ingredients.all[0] }}件)
                                {% if has_less_common.found %}
                                <span class="arrow">▼</span>
                                {% endif %}
                                </h4>
                                <ul>
                                    {% set threshold = ingredients.all[0] * 0.2 %}
                                    {% set visible_count = namespace(value=0) %}
                                    {% for ingredient_name, count_list in ingredients|dictsort(by='value',
                                    reverse=True) %}
                                    {% if ingredient_name != 'all' and count_list[0] >= threshold %}
                                    {% set visible_count.value = visible_count.value + 1 %}
                                    {% endif %}
                                    {% endfor %}

                                    {% set first_item_shown = namespace(value=false) %}
                                    {% for ingredient_name, count_list in ingredients|dictsort(by='value',
                                    reverse=True) %}
                                    {% if ingredient_name != 'all' %}
                                    {% if count_list[0] >= threshold %}
                                    <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                                    {% set first_item_shown.value = true %}
                                    {% elif visible_count.value == 0 and not first_item_shown.value %}
                                    <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                                    {% set first_item_shown.value = true %}
                                    {% else %}
                                    <li class="less-common" style="display: none;">{{ ingredient_name }}: {{
                                        count_list[0] }}件</li>
                                    {% endif %}
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="steps-col">
            <h3>よくある手順</h3>
            {% if details.standard_steps %}
            <ul class="steps-list" data-recipe-index="{{ loop.index0 }}">
                {% for step in details.standard_steps %}
                <li class="step-item {% if loop.index0 >= 20 %}initially-hidden{% endif %}"
                    data-index="{{ loop.index0 }}">
                    ({{ step.food_name }}, {{ step.action }}) ({{ step.count }}件)
                </li>
                {% endfor %}
            </ul>
            {% if details.standard_steps|length > 20 %}
            <button class="show-more-steps" data-recipe-index="{{ loop.index0 }}" data-current-count="20"
                data-total-count="{{ details.standard_steps|length }}">
                もっと表示 (残り{{ details.standard_steps|length - 20 }}件)
            </button>
            {% endif %}
            {% else %}
            <p>手順情報はありません。</p>
            {% endif %}
        </div>
    </div>
    </div>
    {% endfor %}
    {% elif query and not error %}
    <p style="text-align: center;">「{{ query }}」に一致する基準レシピは見つかりませんでした．</p>
    {% endif %}

    <script>
        // JS for Toggles (Standard Recipe Logic)
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButtons = document.querySelectorAll('.toggle-button');
            toggleButtons.forEach(button => {
                if (!button.querySelector('.arrow')) return;
                button.addEventListener('click', () => {
                    const parentCategory = button.closest('.ingredient-category');
                    if (!parentCategory) return;
                    const lessCommonItems = parentCategory.querySelectorAll('.less-common');
                    const arrow = button.querySelector('.arrow');
                    button.classList.toggle('open');
                    lessCommonItems.forEach(item => {
                        item.style.display = (item.style.display === 'none' || item.style.display === '') ? 'list-item' : 'none';
                    });
                    if (arrow) arrow.textContent = button.classList.contains('open') ? '▲' : '▼';
                });
            });

            const otherToggleButtons = document.querySelectorAll('.other-toggle-button');
            otherToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const arrow = button.querySelector('.arrow');
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        if (arrow) arrow.textContent = '▲';
                    } else {
                        content.style.display = 'none';
                        if (arrow) arrow.textContent = '▼';
                    }
                });
            });

            const showMoreButtons = document.querySelectorAll('.show-more-steps');
            showMoreButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const recipeIndex = button.getAttribute('data-recipe-index');
                    const currentCount = parseInt(button.getAttribute('data-current-count'));
                    const totalCount = parseInt(button.getAttribute('data-total-count'));
                    const stepsList = document.querySelector(`.steps-list[data-recipe-index="${recipeIndex}"]`);
                    const stepItems = stepsList.querySelectorAll('.step-item');
                    const newCount = Math.min(currentCount + 10, totalCount);
                    for (let i = currentCount; i < newCount; i++) {
                        if (stepItems[i]) {
                            stepItems[i].style.display = 'list-item';
                        }
                    }
                    button.setAttribute('data-current-count', newCount);
                    const remaining = totalCount - newCount;
                    if (remaining > 0) {
                        button.textContent = `もっと表示 (残り${remaining}件)`;
                    } else {
                        button.style.display = 'none';
                    }
                });
            });
        });
    </script>

    <script>
        // JS for Hybrid Search (Tags + Rows)
        const tagsContainer = document.getElementById('tagsContainer');
        const conditionsContainer = document.getElementById('conditionsContainer');
        const addConditionBtn = document.getElementById('addConditionBtn');
        const searchForm = document.getElementById('searchForm');
        const finalQueryInput = document.getElementById('finalQuery');
        const initialQueryInput = document.getElementById('initialQuery');

        let tags = [];

        // --- タグ関連の関数 ---

        function renderTags() {
            tagsContainer.innerHTML = '';
            tags.forEach(tagText => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';

                const tagLabel = document.createElement('span');
                if (tagText.startsWith('-')) {
                    tagElement.style.backgroundColor = '#dc3545'; // Red for NOT
                    tagLabel.textContent = 'NOT: ' + tagText.substring(1);
                } else {
                    tagLabel.textContent = tagText;
                }

                const removeButton = document.createElement('span');
                removeButton.className = 'tag-remove';
                removeButton.textContent = '×';
                removeButton.onclick = (e) => {
                    e.stopPropagation();
                    removeTag(tagText);
                };

                tagElement.appendChild(tagLabel);
                tagElement.appendChild(removeButton);
                tagsContainer.appendChild(tagElement);
            });
        }

        function removeTag(text) {
            tags = tags.filter(tag => tag !== text);
            renderTags();
        }

        // --- 行関連の関数 ---

        function createConditionRow(val = '', type = 'AND') {
            const row = document.createElement('div');
            row.className = 'condition-row';

            // AND/NOT Select
            const select = document.createElement('select');
            select.className = 'condition-select';
            const optAnd = document.createElement('option');
            optAnd.value = 'AND';
            optAnd.textContent = 'AND (含む)';
            const optNot = document.createElement('option');
            optNot.value = 'NOT';
            optNot.textContent = 'NOT (含まない)';

            if (type === 'NOT') {
                optNot.selected = true;
            } else {
                optAnd.selected = true;
            }

            select.appendChild(optAnd);
            select.appendChild(optNot);

            // Input
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'search-input';
            input.placeholder = 'キーワード';
            input.value = val;

            row.appendChild(select);
            row.appendChild(input);

            // Remove Button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '×';
            removeBtn.onclick = () => {
                row.remove();
                if (conditionsContainer.children.length === 0 && tags.length === 0) {
                    createConditionRow('', 'AND');
                }
            };
            row.appendChild(removeBtn);

            conditionsContainer.appendChild(row);
        }

        // --- 初期化処理 ---

        const initialQuery = initialQueryInput.value;
        if (initialQuery) {
            // 全角スペースを半角に変換して分割
            const tokens = initialQuery.replace(/　/g, ' ').split(' ').filter(t => t.trim() !== '');

            // 既存のクエリはすべてタグとして表示
            tokens.forEach(token => {
                if (!tags.includes(token)) {
                    tags.push(token);
                }
            });
            renderTags();
        }

        // 新規入力用に空の行を1つ追加
        createConditionRow('', 'AND');

        // --- イベントリスナー ---

        addConditionBtn.addEventListener('click', () => {
            createConditionRow();
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();

            let queryParts = [...tags]; // タグを含める

            // 行の入力を取得
            const rows = conditionsContainer.querySelectorAll('.condition-row');
            rows.forEach(row => {
                const type = row.querySelector('select').value;
                const val = row.querySelector('input').value.trim();

                if (val) {
                    if (type === 'NOT') {
                        queryParts.push('-' + val);
                    } else {
                        queryParts.push(val);
                    }
                }
            });

            if (queryParts.length === 0) {
                alert('検索キーワードを入力してください。');
                return;
            }

            finalQueryInput.value = queryParts.join(' ');
            searchForm.submit();
        });
    </script>
    <!-- User ID Display -->
    <div id="user-id-display"
        style="position: fixed; top: 20%; right: 20px; background-color: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 9999; font-family: monospace; font-size: 0.9em;">
        <div style="font-weight: bold; margin-bottom: 5px; font-size: 0.8em; color: #555;">User ID</div>
        <div id="user-id-text" style="display:inline-block; margin-right: 5px; font-weight: bold;">{{ user_id }}</div>
        <button onclick="copyUserId()" style="font-size: 0.8em; cursor: pointer; padding: 2px 6px;">Copy</button>
    </div>
    <script>
        function copyUserId() {
            const userId = document.getElementById('user-id-text').innerText.trim();
            const btn = document.querySelector('#user-id-display button');
            const originalText = btn.innerText;

            const successCallback = () => {
                btn.innerText = 'Copied!';
                setTimeout(() => {
                    btn.innerText = originalText;
                }, 2000);
            };

            const failCallback = (err) => {
                console.error('Copy failed:', err);
                prompt("Copy this ID:", userId);
            };

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(userId).then(successCallback).catch(() => {
                    fallbackCopy(userId, successCallback, failCallback);
                });
            } else {
                fallbackCopy(userId, successCallback, failCallback);
            }
        }

        function fallbackCopy(text, onSuccess, onFail) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) {
                    onSuccess();
                } else {
                    onFail(new Error("execCommand returned false"));
                }
            } catch (err) {
                onFail(err);
            }
        }
    </script>
</body>

</html>