<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>基礎レシピ検索結果: {{ query }}</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 2em auto;
            padding: 0 1em;
            background-color: #f9f9f9;
        }

        .recipe-block {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5em;
            margin-bottom: 2em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        h1,
        h2 {
            color: #333;
        }

        h1 {
            font-size: 1.8em;
        }

        h2 {
            font-size: 1.5em;
            color: #d63384;
            border-bottom: 2px solid #d63384;
            padding-bottom: 0.3em;
            margin-top: 0;
        }

        h3 {
            color: #007BFF;
            margin-top: 0;
            border-left: 4px solid #007BFF;
            padding-left: 0.5em;
        }

        h4 {
            color: #555;
            margin-bottom: 0.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.2em;
        }

        ul {
            list-style-type: none;
            padding-left: 10px;
        }

        li {
            margin-bottom: 0.5em;
            line-height: 1.6;
            font-size: 0.9em;
        }

        a {
            text-decoration: none;
            color: #d63384;
        }

        a:hover {
            text-decoration: underline;
        }

        .recipe-meta {
            background-color: #f8f9fa;
            padding: 1em;
            border-radius: 5px;
            margin-bottom: 1.5em;
        }

        .recipe-meta p {
            margin: 0.5em 0;
        }

        .ingredient-category {
            margin-bottom: 1.5em;
        }

        .toggle-button,
        .other-toggle-button {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding: 5px;
            transition: background-color 0.2s;
        }

        .toggle-button:hover,
        .other-toggle-button:hover {
            background-color: #f0f0f0;
        }

        .toggle-button .arrow,
        .other-toggle-button .arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease-in-out;
        }

        .toggle-button.open .arrow {
            transform: translateY(-50%) rotate(180deg);
        }

        .search-mode-display {
            font-size: 0.7em;
            color: #666;
            font-weight: normal;
        }

        .recipe-details-grid {
            display: flex;
            gap: 2em;
            align-items: flex-start;
        }

        .ingredients-col,
        .steps-col {
            flex: 1;
            min-width: 0;
        }

        .show-more-steps {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 0.5em 1em;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 1em;
            transition: background-color 0.2s;
        }

        .show-more-steps:hover {
            background-color: #0056b3;
        }

        @media (max-width: 700px) {
            .recipe-details-grid {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <h1>
        基礎レシピ検索結果: "{{ query }}"
        {% if search_mode == 'ingredient' %}
        <span class="search-mode-display">(材料名検索)</span>
        {% else %}
        <span class="search-mode-display">(レシピ名検索)</span>
        {% endif %}
    </h1>
    <p><a href="{{ url_for('standard_search_home') }}">← 基礎レシピの検索に戻る</a></p>

    {% if error %}
    <p style="color: red;">{{ error }}</p>
    {% endif %}

    {% if basic_recipes %}
    <p>{{ basic_recipes|length }}件の基礎レシピが見つかりました．</p>

    {% for recipe_name, details in basic_recipes %}
    <div class="recipe-block">
        <h2>{{ recipe_name }}</h2>

        <div class="recipe-meta">
            <p><strong>レシピ数:</strong> {{ details.recipe_count }}</p>
            <p><strong>調理時間:</strong>
                {% if details.cooking_time and details.cooking_time|length > 0 %}
                {{ cooking_time_map.get(details.cooking_time[0], '情報なし') }}
                {% else %}
                情報なし
                {% endif %}
            </p>
            <p><strong>平均手順数:</strong> {{ details.steps.average_steps }}</p>
        </div>

        <div class="recipe-details-grid">
            <div class="ingredients-col">
                <h3>材料の内訳</h3>

                {% set recipe_threshold = details.recipe_count * 0.2 %}

                {# --- 1. 主要な栄養分類 (20%以上) を表示 --- #}
                {% for category_name, ingredients in details.ingredient.items() %}
                {% if ingredients.all[0] >= recipe_threshold %}
                <div class="ingredient-category">
                    {% set has_less_common = namespace(found=false) %}
                    {% for ingredient_name, count_list in ingredients.items() %}
                    {% if ingredient_name != 'all' and count_list[0] < ingredients.all[0] * 0.2 %} {% set
                        has_less_common.found=true %} {% endif %} {% endfor %} <h4 class="toggle-button">
                        {{ category_name }} (合計: {{ ingredients.all[0] }}件)
                        {% if has_less_common.found %}
                        <span class="arrow">▼</span>
                        {% endif %}
                        </h4>
                        <ul>
                            {% set threshold = ingredients.all[0] * 0.2 %}
                            {% set visible_count = namespace(value=0) %}
                            {# Count how many items are above threshold #}
                            {% for ingredient_name, count_list in ingredients|dictsort(by='value', reverse=True) %}
                            {% if ingredient_name != 'all' and count_list[0] >= threshold %}
                            {% set visible_count.value = visible_count.value + 1 %}
                            {% endif %}
                            {% endfor %}

                            {% set first_item_shown = namespace(value=false) %}
                            {% for ingredient_name, count_list in ingredients|dictsort(by='value', reverse=True) %}
                            {% if ingredient_name != 'all' %}
                            {% if count_list[0] >= threshold %}
                            <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                            {% set first_item_shown.value = true %}
                            {% elif visible_count.value == 0 and not first_item_shown.value %}
                            {# If no items above threshold, show the first (highest count) item #}
                            <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                            {% set first_item_shown.value = true %}
                            {% else %}
                            <li class="less-common" style="display: none;">{{ ingredient_name }}: {{ count_list[0] }}件
                            </li>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </ul>
                </div>
                {% endif %}
                {% endfor %}

                {# --- 2. その他の分類 (<20%) をトグルリストにまとめる --- #} <div class="other-categories-block">
                    <h3 class="other-toggle-button">その他の分類 <span class="arrow">▼</span></h3>
                    <div class="other-toggle-content" style="display: none;">
                        {% for category_name, ingredients in details.ingredient.items() %}
                        {% if ingredients.all[0] < recipe_threshold %} <div class="ingredient-category">
                            {% set has_less_common = namespace(found=false) %}
                            {% for ingredient_name, count_list in ingredients.items() %}
                            {% if ingredient_name != 'all' and count_list[0] < ingredients.all[0] * 0.2 %} {% set
                                has_less_common.found=true %} {% endif %} {% endfor %} <h4 class="toggle-button">
                                {{ category_name }} (合計: {{ ingredients.all[0] }}件)
                                {% if has_less_common.found %}
                                <span class="arrow">▼</span>
                                {% endif %}
                                </h4>
                                <ul>
                                    {% set threshold = ingredients.all[0] * 0.2 %}
                                    {% set visible_count = namespace(value=0) %}
                                    {# Count how many items are above threshold #}
                                    {% for ingredient_name, count_list in ingredients|dictsort(by='value', reverse=True)
                                    %}
                                    {% if ingredient_name != 'all' and count_list[0] >= threshold %}
                                    {% set visible_count.value = visible_count.value + 1 %}
                                    {% endif %}
                                    {% endfor %}

                                    {% set first_item_shown = namespace(value=false) %}
                                    {% for ingredient_name, count_list in ingredients|dictsort(by='value', reverse=True)
                                    %}
                                    {% if ingredient_name != 'all' %}
                                    {% if count_list[0] >= threshold %}
                                    <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                                    {% set first_item_shown.value = true %}
                                    {% elif visible_count.value == 0 and not first_item_shown.value %}
                                    {# If no items above threshold, show the first (highest count) item #}
                                    <li>{{ ingredient_name }}: {{ count_list[0] }}件</li>
                                    {% set first_item_shown.value = true %}
                                    {% else %}
                                    <li class="less-common" style="display: none;">{{ ingredient_name }}: {{
                                        count_list[0] }}件</li>
                                    {% endif %}
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                    </div>
                    {% endif %}
                    {% endfor %}
            </div>
        </div>
    </div>

    <div class="steps-col">
        <h3>よくある手順</h3>
        {% if details.standard_steps %}
        <ul class="steps-list" data-recipe-index="{{ loop.index0 }}">
            {% for step in details.standard_steps %}
            <li class="step-item" data-index="{{ loop.index0 }}"
                style="display: {% if loop.index0 < 20 %}list-item{% else %}none{% endif %};">
                ({{ step.food_name }}, {{ step.action }}) ({{ step.count }}件)
            </li>
            {% endfor %}
        </ul>
        {% if details.standard_steps|length > 20 %}
        <button class="show-more-steps" data-recipe-index="{{ loop.index0 }}" data-current-count="20"
            data-total-count="{{ details.standard_steps|length }}">
            もっと表示 (残り{{ details.standard_steps|length - 20 }}件)
        </button>
        {% endif %}
        {% else %}
        <p>手順情報はありません。</p>
        {% endif %}
    </div>
    </div>
    </div>
    {% endfor %}
    {% elif query and not error %}
    <p>「{{ query }}」に一致する基礎レシピは見つかりませんでした．</p>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 各栄養分類内の材料リストのトグル処理 ---
            const toggleButtons = document.querySelectorAll('.toggle-button');
            toggleButtons.forEach(button => {
                if (!button.querySelector('.arrow')) return;
                button.addEventListener('click', () => {
                    const parentCategory = button.closest('.ingredient-category');
                    if (!parentCategory) return;
                    const lessCommonItems = parentCategory.querySelectorAll('.less-common');
                    const arrow = button.querySelector('.arrow');
                    button.classList.toggle('open');
                    lessCommonItems.forEach(item => {
                        item.style.display = (item.style.display === 'none' || item.style.display === '') ? 'list-item' : 'none';
                    });
                    if (arrow) arrow.textContent = button.classList.contains('open') ? '▲' : '▼';
                });
            });

            // --- 「その他の分類」ブロック全体のトグル処理 ---
            const otherToggleButtons = document.querySelectorAll('.other-toggle-button');
            otherToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const arrow = button.querySelector('.arrow');

                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        if (arrow) arrow.textContent = '▲';
                    } else {
                        content.style.display = 'none';
                        if (arrow) arrow.textContent = '▼';
                    }
                });
            });

            // --- 「もっと表示」ボタンの処理 ---
            const showMoreButtons = document.querySelectorAll('.show-more-steps');
            showMoreButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const recipeIndex = button.getAttribute('data-recipe-index');
                    const currentCount = parseInt(button.getAttribute('data-current-count'));
                    const totalCount = parseInt(button.getAttribute('data-total-count'));
                    const stepsList = document.querySelector(`.steps-list[data-recipe-index="${recipeIndex}"]`);
                    const stepItems = stepsList.querySelectorAll('.step-item');

                    // 次の10件を表示
                    const newCount = Math.min(currentCount + 10, totalCount);
                    for (let i = currentCount; i < newCount; i++) {
                        if (stepItems[i]) {
                            stepItems[i].style.display = 'list-item';
                        }
                    }

                    // ボタンのテキストと状態を更新
                    button.setAttribute('data-current-count', newCount);
                    const remaining = totalCount - newCount;
                    if (remaining > 0) {
                        button.textContent = `もっと表示 (残り${remaining}件)`;
                    } else {
                        button.style.display = 'none';
                    }
                });
            });
        });
    </script>

</body>

</html>